# eRob_PT.cpp EtherCAT主站程序功能说明文档

> **语言切换**: [English Version](eRob_PT_Project_Introduction_EN.md) | 中文版

## 项目介绍

**eRob_PT** 是一个基于SOEM（Simple Open EtherCAT Master）库开发的高性能EtherCAT主站控制系统，专门设计用于伺服电机的精确控制和系统辨识。该项目集成了先进的电机控制算法、摩擦力补偿、重力补偿和系统辨识功能，为机器人关节控制、精密定位系统等应用提供了完整的解决方案。

### 核心特性

- **实时EtherCAT通信**: 基于SOEM库实现完整的EtherCAT协议栈，支持多从站设备管理和实时数据交换
- **多模式电机控制**: 支持电流环、速度环等多种控制模式，可根据应用需求灵活切换
- **智能补偿算法**: 集成摩擦力补偿和重力补偿算法，显著提升系统控制精度
- **系统辨识功能**: 内置正弦扫频和阶跃响应测试，支持传递函数自动识别和参数优化
- **实时性能优化**: 针对树莓派等嵌入式平台进行CPU隔离优化，确保通信实时性

### 技术架构

- **通信协议**: EtherCAT实时以太网协议
- **主控平台**: Linux系统（支持树莓派、PC等）
- **开发语言**: C++
- **实时性**: 微秒级通信周期
- **扩展性**: 支持多从站设备级联

## 使用说明

### 编译与运行
```bash
git clone git@github.com:ZeroErrControl/eRob_Compensation_Controller.git
cd eRob_Compensation_Controller
mkdir build && cd build
cmake ..
make
sudo ./demo/eRob_PT
```

### 控制操作
- **P键**: 切换控制模式
- **W/S键**: 在速度模式下控制速度变化
  - W: 增加速度
  - S: 减少速度

## 免责声明

⚠️ **重要安全提醒**

本程序仅供学习和研究使用，一切实验必须做好安全防护措施。**请勿在实际生产场景中直接使用该demo程序**。

### 安全要求
- 确保电机和关节牢固固定，防止意外移动或倾倒
- 避免在扭矩模式和参数辨识模式下进行危险操作
- 操作前检查所有连接和防护措施
- 保持安全距离，避免高速旋转造成伤害

### 免责条款
使用者需自行承担使用本程序的所有风险，开发者不对任何因使用本程序而造成的损失、伤害或事故承担责任。使用前请充分了解相关风险并采取必要的安全措施。

> **相关资源**: 更多详细的操作演示和教程视频，请参考：[抖音@翼之道男](https://www.douyin.com/root/search/%E7%BF%BC%E4%B9%8B%E9%81%93%E7%94%B7?aid=162e4cd5-cc26-4b15-91bf-8564670a63ce&modal_id=7537173963715300634&type=general)

# 软件复现步骤记录

## 第一步：硬件连接与安全准备
1. 连接电机、树莓派、电源及通信线。  
2. **安全注意事项**：
   - 电机必须牢固固定在台架上，防止倾倒。  
   - 电机工作范围内不得有遮挡，且保持远离人员，避免高速旋转造成伤害。  

---

## 第二步：下载与编译代码
- 获取项目代码并完成编译。  

---

## 第三步：树莓派平台运行准备（仅针对树莓派 3B）
- 隔离 CPU 2、3 核心，专供程序运行，以确保通信实时性。  

---

## 第四步：测试通信线路
1. 确保电机空载运行，不连接任何负载。  
2. 运行程序：  
   - 按 **P** 键切换控制模式，观察电机是否正常转动。  
   - 切换至速度模式（P 键），用 **W/S** 键控制电机转速，确认运行正常。  
   - 按 **B** 键可关闭电机。  

---

## 第五步：摩擦力辨识
1. 确保电机空载运行。  
2. 按 **P** 键切换至摩擦力辨识模式：  
   - 电机从 0 加速至 29 rpm，采集平均速度与电流数据。  
   - 完成正转后，停下并进行反转测试。  
3. 导出运行目录下的 `data.txt` 文件至 MATLAB，绘制速度-电流曲线并验证正确性。  
4. 将每个速度对应的正反方向电流取平均值，填入摩擦力参数表。  

---

## 第六步：验证摩擦力补偿算法
1. 安装连杆。  
2. 启动程序，按 **P** 键切换至摩擦力补偿模式。  
3. 徒手拨动连杆，观察补偿效果。  
4. 若补偿不足，调整摩擦力补偿放大系数。  

---

## 第七步：重力补偿
1. 给连杆加装负载铁片。  
2. 启动程序并进入速度模式（P 键切换）。  
3. 使用 **W/S** 键调整转速，让连杆停在水平位置。  
4. 从日志读取此时电流值，填写至重力补偿参数中。  
5. **注意**：需提前归零编码器，保证连杆水平时电机角度为 90°。  

---

## 第八步：验证重力补偿效果
1. 运行程序，按 **P** 键切换至摩擦+重力补偿模式。  
2. 徒手转动负载和连杆，观察补偿效果。  
3. 若补偿不足，可手动微调增益系数。  

---

## 第九步：速度环模型辨识
1. 运行程序，按 **P** 键切换至正弦扫频模式。  
2. 电机带动负载做正弦振动，频率逐渐升高直至停止。  
3. 导出 `data.txt` 至 MATLAB，使用系统辨识工具箱识别传递函数。  

---

## 第十步：模型验证与参数写入
1. 将传递函数通过 c2 方法离散化，得到系数并写入程序。  
2. 运行程序，按 **P** 键切换至阶跃测试模式。  
3. 测试结束后导出数据至 MATLAB，验证模型跟随效果。  
